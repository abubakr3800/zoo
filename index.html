<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Zoo Lighting Impact Simulator - Night Study</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color: #121212; }
    .enclosure {
      position: relative;
      width: 100%;
      height: 400px;
      background-size: cover;
      background-position: center;
      border-radius: 10px;
      transition: filter 0.3s ease, background-image 0.3s ease;
    }
    .text-safe { color: #0f0; }
    .text-warning { color: #ff0; }
    .text-danger { color: #f00; }
  </style>
</head>
<body class="text-white">
<div class="container py-4">
  <h1 class="mb-4 text-center">Zoo Lighting Impact Simulator (Night Study)</h1>

  <div class="row g-4">
    <!-- Simulation Area -->
    <div class="col-md-4">
      <div id="enclosure" class="enclosure bg-dark"></div>
    </div>

    <!-- Controls -->
    <div class="col-md-8">
      <div class="card bg-secondary text-white">
        <div class="card-body">
          <h5>Lighting Controls</h5>

          <label class="form-label mt-2">Animal</label>
          <select id="animalSelect" class="form-select">
            <option value="lion">Lion</option>
          </select>

          <label class="form-label mt-2">Mode (Night Activity)</label>
          <select id="modeSelect" class="form-select">
            <!-- will populate dynamically -->
          </select>

          <div class="mt-3">
            <label class="form-label">Color Temperature (K): 
              <span id="tempValue">0</span>
            </label>
            <input type="range" min="1500" max="10000" value="3500" step="100" id="tempSlider" class="form-range">
            <small id="tempReason"></small>
          </div>

          <div class="mt-3">
            <label class="form-label">Lux Level: 
              <span id="luxValue">0</span>
            </label>
            <input type="range" min="0" max="1000" value="200" step="10" id="luxSlider" class="form-range">
            <small id="luxReason"></small>
          </div>

          <div class="mt-3">
            <label class="form-label">CRI: 
              <span id="criValue">0</span>
            </label>
            <input type="range" min="60" max="100" value="90" step="1" id="criSlider" class="form-range">
            <small id="criReason"></small>
          </div>

          <div class="mt-3">
            <label class="form-label">Glare</label>
            <select id="glareSelect" class="form-select">
              <option value="none">None</option>
              <option value="present">Present</option>
            </select>
            <small id="glareReason"></small>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Avoid Rules -->
  <div class="row mt-4">
    <div class="col">
      <div class="card bg-dark text-white">
        <div class="card-body">
          <h5 class="card-title">Avoid Patterns Triggered</h5>
          <div id="avoidRules"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
let lightingData = {};
let selectedAnimal = "lion";
let selectedMode = null;

const tempSlider = document.getElementById('tempSlider');
const luxSlider = document.getElementById('luxSlider');
const criSlider = document.getElementById('criSlider');
const glareSelect = document.getElementById('glareSelect');

const tempValue = document.getElementById('tempValue');
const luxValue = document.getElementById('luxValue');
const criValue = document.getElementById('criValue');

async function loadLightingData() {
  const res = await fetch("database/db.json");
  lightingData = await res.json();

  const modeSelect = document.getElementById('modeSelect');
  modeSelect.innerHTML = "";
  lightingData[selectedAnimal].lighting_conditions.forEach((cond, idx) => {
    const opt = document.createElement("option");
    opt.value = idx;
    opt.textContent = cond.activity;
    modeSelect.appendChild(opt);
  });
  selectedMode = 0;
  updateSimulation();
}

function updateSimulation() {
  const cond = lightingData[selectedAnimal].lighting_conditions[selectedMode];
  const temp = parseInt(tempSlider.value);
  const lux = parseInt(luxSlider.value);
  const cri = parseInt(criSlider.value);
  const glare = glareSelect.value;

  tempValue.textContent = temp;
  luxValue.textContent = lux;
  criValue.textContent = cri;

  const avoidDiv = document.getElementById('avoidRules');
  avoidDiv.innerHTML = "";

  // Reset colors
  tempValue.className = "";
  luxValue.className = "";
  criValue.className = "";

  // Check avoid rules
  for (const [key, obj] of Object.entries(cond.avoid)) {
    let violated = false;

    if (key.toLowerCase().includes("cct") || key.toLowerCase().includes("blue")) {
      if (temp < obj.min || temp > obj.max) violated = true;
    }
    if (key.toLowerCase().includes("lux") || key.toLowerCase().includes("lighting_changes")) {
      if (lux < obj.min || lux > obj.max) violated = true;
    }
    if (key.toLowerCase().includes("flicker") || key.toLowerCase().includes("cri")) {
      if (cri < obj.min || cri > obj.max) violated = true;
    }
    if (key.toLowerCase().includes("glare") || key.toLowerCase().includes("point_sources")) {
      if (glare === "present") violated = true;
    }

    if (violated) {
      const p = document.createElement("p");
      p.textContent = `${key}: ${obj.description}`;
      avoidDiv.appendChild(p);

      // Highlight affected value in red
      if (key.toLowerCase().includes("cct") || key.toLowerCase().includes("blue")) tempValue.className = "text-danger";
      if (key.toLowerCase().includes("lux") || key.toLowerCase().includes("lighting_changes")) luxValue.className = "text-danger";
      if (key.toLowerCase().includes("flicker") || key.toLowerCase().includes("cri")) criValue.className = "text-danger";
      if (key.toLowerCase().includes("glare") || key.toLowerCase().includes("point_sources")) glareSelect.className = "form-select border border-danger";
    }
  }
}

document.getElementById('animalSelect').addEventListener('change', e => {
  selectedAnimal = e.target.value;
  loadLightingData();
});

document.getElementById('modeSelect').addEventListener('change', e => {
  selectedMode = parseInt(e.target.value);
  updateSimulation();
});

[tempSlider, luxSlider, criSlider, glareSelect].forEach(el => {
  el.addEventListener('input', updateSimulation);
});

loadLightingData();
</script>
</body>
</html>
