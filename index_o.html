<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Zoo Lighting Impact Simulator — Night Study</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    :root{
      --bg:#0b0b0f;
      --card:#1f2933;
      --muted:#98a0a6;
      --danger:#ff4d4f;
      --ok:#4ad994;
    }
    body { background: var(--bg); color: #fff; font-family: Inter, system-ui, sans-serif; }
    .container { max-width: 1100px; }
    .enclosure {
      position: relative;
      width: 100%;
      height: 400px;
      background-size: cover;
      background-position: center;
      border-radius: 10px;
      overflow: hidden;
      transition: filter 250ms linear, background-image 300ms ease;
      background-color: #111;
    }
    .enclosure.glare::before {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at 55% 35%, rgba(255,255,210,0.55) 0%, rgba(255,255,210,0.18) 20%, transparent 50%);
      mix-blend-mode: screen;
    }
    .stat-pill { display:inline-block; padding:6px 8px; border-radius:6px; background:rgba(255,255,255,0.05); margin-left:8px; font-weight:600; }
    .value-ok { color: var(--ok); font-weight: 600; }
    .value-bad { color: var(--danger); font-weight: 700; }
    .avoid-rule { border-left: 3px solid rgba(255,255,255,0.06); padding-left: 10px; margin-bottom: 8px; }
    .meta { color: var(--muted); font-size: 0.92rem; }
  </style>
</head>
<body>
  <div class="container py-4">
    <h1 class="text-center mb-4">Zoo Lighting Impact Simulator — Night Study</h1>
    <div class="row g-4">
      <div class="col-lg-4">
        <div id="enclosure" class="enclosure"></div>
        <p class="meta mt-2">Preview reflects applied CCT · Lux · CRI · Glare</p>
      </div>
      <div class="col-lg-8">
        <div class="card p-3">
          <div class="row g-3">
            <div class="col-12 col-md-6">
              <label class="form-label">Animal</label>
              <select id="animalSelect" class="form-select"></select>
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label">Mode</label>
              <select id="modeSelect" class="form-select"></select>
            </div>
            <div class="col-12">
              <label class="form-label">CCT (K) <span id="tempSpan" class="stat-pill">—</span></label>
              <input id="tempSlider" type="range" class="form-range" min="1500" max="10000" step="100" value="2000">
            </div>
            <div class="col-12">
              <label class="form-label">Lux <span id="luxSpan" class="stat-pill">—</span></label>
              <input id="luxSlider" type="range" class="form-range" min="0" max="1000" step="10" value="5">
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label">CRI <span id="criSpan" class="stat-pill">—</span></label>
              <input id="criSlider" type="range" class="form-range" min="0" max="100" step="1" value="0">
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label">Glare</label>
              <select id="glareSelect" class="form-select">
                <option value="0">None</option>
                <option value="1">Present</option>
              </select>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="card p-3 mt-4">
      <h5>Avoid Patterns Triggered</h5>
      <div id="avoidRules" class="mb-2"><p class="meta">No rules triggered.</p></div>
    </div>
  </div>

<script>
let lightingData = {};
let selectedAnimal = '';
let selectedModeIndex = 0;

const enclosure = document.getElementById('enclosure');
const animalSelect = document.getElementById('animalSelect');
const modeSelect = document.getElementById('modeSelect');
const tempSlider = document.getElementById('tempSlider');
const luxSlider = document.getElementById('luxSlider');
const criSlider = document.getElementById('criSlider');
const glareSelect = document.getElementById('glareSelect');
const tempSpan = document.getElementById('tempSpan');
const luxSpan = document.getElementById('luxSpan');
const criSpan = document.getElementById('criSpan');
const avoidRulesDiv = document.getElementById('avoidRules');

function clamp(v, a, b){ return Math.max(a, Math.min(b, v)); }

function applyVisualFilters(cct, lux, cri, glareFlag){
  let warmthRatio = (cct - 2000) / (5000 - 2000);
  warmthRatio = clamp(warmthRatio, -1, 1);
  let hueShift = (warmthRatio < 0.5)
    ? -40 * (0.5 - warmthRatio) * 2
    : 40 * (warmthRatio - 0.5) * 2;

  let brightness = clamp(lux / 300, 0.05, 3);
  let saturation = clamp(0.3 + (cri / 100) * 1.5, 0.2, 3);

  enclosure.style.filter = `brightness(${brightness}) contrast(1) hue-rotate(${hueShift}deg) saturate(${saturation})`;
  enclosure.classList.toggle('glare', !!glareFlag);
}

function ruleViolates(rule, value) {
  if (typeof value !== 'number') return false;

  switch (rule.operator) {
    case 'gt':
      return rule.max !== undefined && value > rule.max;
    case 'lt':
      return rule.min !== undefined && value < rule.min;
    case 'eq':
      return value === rule.min;
    case 'in_range':
      return value >= rule.min && value <= rule.max;
    default:
      if (rule.min !== undefined && rule.max !== undefined) {
        return value < rule.min || value > rule.max;
      }
      if (rule.min !== undefined) {
        return value < rule.min;
      }
      if (rule.max !== undefined) {
        return value > rule.max;
      }
      return false;
  }
}

function updateSimulation() {
  const cond = lightingData[selectedAnimal]?.lighting_conditions[selectedModeIndex];
  if (!cond) return;

  // Clamp slider values inside the mode's allowed ranges
  if (Number(tempSlider.value) < cond.CCT_K.min || Number(tempSlider.value) > cond.CCT_K.max) {
    tempSlider.value = cond.CCT_K.min;
  }
  if (Number(luxSlider.value) < cond.illuminance_lux.min || Number(luxSlider.value) > cond.illuminance_lux.max) {
    luxSlider.value = cond.illuminance_lux.min;
  }
  if (Number(criSlider.value) < cond.CRI_Ra.min || Number(criSlider.value) > cond.CRI_Ra.max) {
    criSlider.value = cond.CRI_Ra.min;
  }

  const cct = Number(tempSlider.value);
  const lux = Number(luxSlider.value);
  const cri = Number(criSlider.value);
  const glareFlag = Number(glareSelect.value);

  tempSpan.textContent = `${cct}K`;
  luxSpan.textContent = `${lux} lx`;
  criSpan.textContent = `${cri}`;

  // Reset styles
  tempSpan.className = "stat-pill";
  luxSpan.className = "stat-pill";
  criSpan.className = "stat-pill";
  glareSelect.classList.remove("border-danger");

  // Check if values are in safe ranges, mark bad if out of range
  let avoidTriggered = false;

  if (cct < cond.CCT_K.min || cct > cond.CCT_K.max) {
    tempSpan.classList.add("value-bad");
    avoidTriggered = true;
  } else {
    tempSpan.classList.add("value-ok");
  }

  if (lux < cond.illuminance_lux.min || lux > cond.illuminance_lux.max) {
    luxSpan.classList.add("value-bad");
    avoidTriggered = true;
  } else {
    luxSpan.classList.add("value-ok");
  }

  if (cri < cond.CRI_Ra.min || cri > cond.CRI_Ra.max) {
    criSpan.classList.add("value-bad");
    avoidTriggered = true;
  } else {
    criSpan.classList.add("value-ok");
  }

  // Check avoid rules
  avoidRulesDiv.innerHTML = "";
  for (const [key, rule] of Object.entries(cond.avoid)) {
    let valueToCheck = null;
    const k = key.toLowerCase();

    // Map keys to values to check
    if (k.includes("blue")) valueToCheck = cct;
    else if (k.includes("lighting_changes") || k.includes("lux")) valueToCheck = lux;
    else if (k.includes("cri") || k.includes("flicker")) valueToCheck = cri;
    else if (k.includes("point") || k.includes("glare") || k.includes("shadows")) valueToCheck = glareFlag;

    if (valueToCheck !== null && ruleViolates(rule, valueToCheck)) {
      avoidTriggered = true;
      const p = document.createElement("p");
      p.className = "avoid-rule text-danger";
      p.innerHTML = `<strong>${key}</strong>: ${rule.description} 
        <span class="meta">(You: ${valueToCheck}, Avoid: ${rule.min ?? '-'}–${rule.max ?? '-'})</span>`;
      avoidRulesDiv.appendChild(p);
    }
  }

  if (!avoidTriggered) {
    avoidRulesDiv.innerHTML = `<p class="meta">No avoid patterns triggered.</p>`;
  }

  applyVisualFilters(cct, lux, cri, glareFlag);

  // Set enclosure image: annoyed if avoid rules or out of range, else normal image
  enclosure.style.backgroundImage = `url("${avoidTriggered ? "images/lion/gif/anoyed.gif" : cond.image}")`;
}

function populateModes(){
  const list = lightingData[selectedAnimal]?.lighting_conditions ?? [];
  modeSelect.innerHTML = '';
  list.forEach((c, i) => {
    const opt = document.createElement('option');
    opt.value = i;
    opt.textContent = c.activity || `mode ${i+1}`;
    modeSelect.appendChild(opt);
  });
  selectedModeIndex = 0;
  modeSelect.value = 0;
}

async function loadLightingJSON(){
  const res = await fetch('database/db.json');
  lightingData = await res.json();
  animalSelect.innerHTML = '';
  Object.keys(lightingData).forEach(an => {
    const o = document.createElement('option');
    o.value = an;
    o.textContent = an.charAt(0).toUpperCase() + an.slice(1);
    animalSelect.appendChild(o);
  });
  selectedAnimal = animalSelect.value;
  populateModes();
  updateSimulation();
}

animalSelect.addEventListener('change', e => {
  selectedAnimal = e.target.value;
  populateModes();
  updateSimulation();
});
modeSelect.addEventListener('change', e => {
  selectedModeIndex = Number(e.target.value);
  updateSimulation();
});
[tempSlider, luxSlider, criSlider, glareSelect].forEach(el => { el.addEventListener('input', updateSimulation); });

loadLightingJSON();
</script>
</body>
</html>
